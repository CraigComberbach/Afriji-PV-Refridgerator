/**************************************************************************************************
Target Hardware:		PIC24FJ256GA106
Code assumptions:		
Purpose:				
Notes:					

Version History:
vnext	Y-M-D	Craig Comberbach
Compiler: XC16 v1.26	IDE: MPLABx 3.30	Tool: ICD3	Computer: Intel Core2 Quad CPU 2.40 GHz, 5 GB RAM, Windows 10 64 bit Home
	First version
**************************************************************************************************/
/*************    Header Files    ***************/
#include "Config.h"
#include "Inverter.h"

/************* Library Definition ***************/
/************* Semantic Versioning***************/
/*************Library Dependencies***************/
/************Arbitrary Functionality*************/
/*************   Magic  Numbers   ***************/
#define	PERIOD	1599
#define MULTIPLIER 1
#define DIVIDER 1//12-20

/*************    Enumeration     ***************/
/***********  Structure Definitions  ************/
/***********State Machine Definitions************/
/*************  Global Variables  ***************/
unsigned int inverterLevel[] =
{
//100kHz @ 1024 points
//  0,  1,  1,  1,  1,  1,  1,  1,  1,  1,  1,  1,  1,  1,  1,  1,  1,  1,  1,  1,  1,  1,  1,  1,  1,  1,  2,  2,  2,  2,  2,  2,
//  2,  2,  2,  2,  2,  2,  2,  2,  2,  2,  2,  2,  2,  4,  4,  4,  4,  4,  4,  4,  4,  4,  4,  4,  4,  4,  6,  6,  6,  6,  6,  6,
//  6,  6,  6,  6,  6,  8,  8,  8,  8,  8,  8,  8,  8,  8, 10, 10, 10, 10, 10, 10, 10, 10, 10, 12, 12, 12, 12, 12, 12, 12, 14, 14,
// 14, 14, 14, 14, 14, 14, 16, 16, 16, 16, 16, 16, 16, 18, 18, 18, 18, 18, 18, 20, 20, 20, 20, 20, 20, 22, 22, 22, 22, 22, 22, 24,
// 24, 24, 24, 24, 24, 26, 26, 26, 26, 26, 26, 28, 28, 28, 28, 28, 30, 30, 30, 30, 30, 32, 32, 32, 32, 32, 34, 34, 34, 34, 34, 36,
// 36, 36, 36, 36, 38, 38, 38, 38, 38, 40, 40, 40, 40, 40, 42, 42, 42, 42, 44, 44, 44, 44, 44, 46, 46, 46, 46, 46, 48, 48, 48, 48,
// 50, 50, 50, 50, 50, 52, 52, 52, 52, 54, 54, 54, 54, 56, 56, 56, 56, 56, 58, 58, 58, 58, 60, 60, 60, 60, 62, 62, 62, 62, 64, 64,
// 64, 64, 66, 66, 66, 66, 66, 68, 68, 68, 68, 70, 70, 70, 70, 72, 72, 72, 72, 74, 74, 74, 74, 76, 76, 76, 76, 78, 78, 78, 78, 81,
// 81, 81, 81, 81, 81, 83, 83, 83, 83, 85, 85, 85, 85, 87, 87, 87, 87, 89, 89, 89, 89, 91, 91, 91, 91, 93, 93, 93, 93, 93, 95, 95,
// 95, 95, 97, 97, 97, 97, 99, 99, 99, 99,101,101,101,101,103,103,103,103,103,105,105,105,105,107,107,107,107,109,109,109,109,109,
//111,111,111,111,113,113,113,113,113,115,115,115,115,115,117,117,117,117,119,119,119,119,119,121,121,121,121,121,123,123,123,123,
//123,125,125,125,125,125,127,127,127,127,127,129,129,129,129,129,131,131,131,131,131,133,133,133,133,133,133,135,135,135,135,135,
//135,137,137,137,137,137,137,139,139,139,139,139,139,141,141,141,141,141,141,143,143,143,143,143,143,143,145,145,145,145,145,145,
//145,145,147,147,147,147,147,147,147,149,149,149,149,149,149,149,149,149,151,151,151,151,151,151,151,151,151,153,153,153,153,153,
//153,153,153,153,153,153,155,155,155,155,155,155,155,155,155,155,155,155,155,157,157,157,157,157,157,157,157,157,157,157,157,157,
//157,157,157,157,157,157,158,158,158,158,158,158,158,158,158,158,158,158,158,158,158,158,158,158,158,158,158,158,158,158,158,158,
//158,158,158,158,158,158,158,158,158,158,158,158,158,158,158,158,158,158,158,158,158,158,158,158,158,158,157,157,157,157,157,157,
//157,157,157,157,157,157,157,157,157,157,157,157,157,155,155,155,155,155,155,155,155,155,155,155,155,155,153,153,153,153,153,153,
//153,153,153,153,153,151,151,151,151,151,151,151,151,151,151,149,149,149,149,149,149,149,149,147,147,147,147,147,147,147,147,145,
//145,145,145,145,145,145,143,143,143,143,143,143,143,141,141,141,141,141,141,141,139,139,139,139,139,139,137,137,137,137,137,137,
//135,135,135,135,135,133,133,133,133,133,133,131,131,131,131,131,129,129,129,129,129,129,127,127,127,127,127,125,125,125,125,125,
//123,123,123,123,123,121,121,121,121,121,119,119,119,119,117,117,117,117,117,115,115,115,115,115,113,113,113,113,111,111,111,111,
//111,109,109,109,109,107,107,107,107,105,105,105,105,105,103,103,103,103,101,101,101,101, 99, 99, 99, 99, 99, 97, 97, 97, 97, 95,
// 95, 95, 95, 93, 93, 93, 93, 91, 91, 91, 91, 89, 89, 89, 89, 87, 87, 87, 87, 87, 85, 85, 85, 85, 83, 83, 83, 83, 81, 81, 81, 81,
// 78, 78, 78, 78, 76, 76, 76, 76, 74, 74, 74, 74, 72, 72, 72, 72, 72, 70, 70, 70, 70, 68, 68, 68, 68, 66, 66, 66, 66, 64, 64, 64,
// 64, 62, 62, 62, 62, 60, 60, 60, 60, 60, 58, 58, 58, 58, 56, 56, 56, 56, 54, 54, 54, 54, 54, 52, 52, 52, 52, 50, 50, 50, 50, 48,
// 48, 48, 48, 48, 46, 46, 46, 46, 44, 44, 44, 44, 44, 42, 42, 42, 42, 42, 40, 40, 40, 40, 38, 38, 38, 38, 38, 36, 36, 36, 36, 36,
// 34, 34, 34, 34, 34, 32, 32, 32, 32, 32, 30, 30, 30, 30, 30, 30, 28, 28, 28, 28, 28, 26, 26, 26, 26, 26, 26, 24, 24, 24, 24, 24,
// 22, 22, 22, 22, 22, 22, 20, 20, 20, 20, 20, 20, 18, 18, 18, 18, 18, 18, 18, 16, 16, 16, 16, 16, 16, 16, 14, 14, 14, 14, 14, 14,
// 14, 12, 12, 12, 12, 12, 12, 12, 12, 10, 10, 10, 10, 10, 10, 10, 10,  8,  8,  8,  8,  8,  8,  8,  8,  8,  8,  6,  6,  6,  6,  6,
//  6,  6,  6,  6,  6,  6,  4,  4,  4,  4,  4,  4,  4,  4,  4,  4,  4,  4,  4,  2,  2,  2,  2,  2,  2,  2,  2,  2,  2,  2,  2,  2,
//  2,  2,  2,  2,  2,  2,  1,  1,  1,  1,  1,  1,  1,  1,  1,  1,  1,  1,  1,  1,  1,  1,  1,  1,  1,  1,  1,  1,  1,  1,  1,  0
////10kHz @ 120 points
//41,		83,		124,	166,	207,	248,	289,	330,	371,	411,
//451,	491,	530,	569,	608,	646,	684,	721,	758,	795,
//830,	865,	900,	934,	967,	1000,	1032,	1063,	1094,	1124,
//1153,	1181,	1209,	1235,	1261,	1286,	1310,	1333,	1355,	1376,
//1397,	1416,	1435,	1452,	1468,	1484,	1498,	1512,	1524,	1535,
//1546,	1555,	1563,	1570,	1576,	1581,	1585,	1587,	1589,	1590,
//1589,	1587,	1585,	1581,	1576,	1570,	1563,	1555,	1546,	1535,
//1524,	1512,	1498,	1484,	1468,	1452,	1435,	1416,	1397,	1376,
//1355,	1333,	1310,	1286,	1261,	1235,	1209,	1181,	1153,	1124,
//1094,	1063,	1032,	1000,	967,	934,	900,	865,	830,	795,
//758,	721,	684,	646,	608,	569,	530,	491,	451,	411,
//371,	330,	289,	248,	207,	166,	124,	83,		41,		0,
////100kHz @ 120 point s
//4,		8,		12,		16,		20,		24,		28,		33,		37,		41,
//45,		49,		53,		56,		60,		64,		68,		72,		75,		79,
//83,		86,		90,		93,		96,		100,	103,	106,	109,	112,
//115,	118,	120,	123,	126,	128,	131,	133,	135,	137,
//139,	141,	143,	145,	146,	148,	149,	151,	152,	153,
//154,	155,	156,	157,	157,	158,	158,	158,	158,	159,
//158,	158,	158,	158,	157,	157,	156,	155,	154,	153,
//152,	151,	149,	148,	146,	145,	143,	141,	139,	137,
//135,	133,	131,	128,	126,	123,	120,	118,	115,	112,
//109,	106,	103,	100,	96,		93,		90,		86,		83,		79,
//75,		72,		68,		64,		60,		56,		53,		49,		45,		41,
//37,		33,		28,		24,		20,		16,		12,		8,		4,		0

//10kHz @ 180 points
0,		17,		35,		52,		70,		87,		105,	122,	139,	156,	174,	191,	208,	225,	242,	259,	276,	292,	309,	326,
342,	358,	375,	391,	407,	423,	438,	454,	469,	485,	500,	515,	530,	545,	559,	574,	588,	602,	616,	629,
643,	656,	669,	682,	695,	707,	719,	731,	743,	755,	766,	777,	788,	799,	809,	819,	829,	839,	848,	857,
866,	875,	883,	891,	899,	906,	914,	921,	927,	934,	940,	946,	951,	956,	961,	966,	970,	974,	978,	982,
985,	988,	990,	993,	995,	996,	998,	999,	999,	1000,	1000,	1000,	999,	999,	998,	996,	995,	993,	990,	988,
985,	982,	978,	974,	970,	966,	961,	956,	951,	946,	940,	934,	927,	921,	914,	906,	899,	891,	883,	875,
866,	857,	848,	839,	829,	819,	809,	799,	788,	777,	766,	755,	743,	731,	719,	707,	695,	682,	669,	656,
643,	629,	616,	602,	588,	574,	559,	545,	530,	515,	500,	485,	469,	454,	438,	423,	407,	391,	375,	358,
342,	326,	309,	292,	276,	259,	242,	225,	208,	191,	174,	156,	139,	122,	105,	87,		70,		52,		35,		17


};

/*************Interrupt Prototypes***************/
/*************Function  Prototypes***************/
void Positive_Wave(int currentStep);
void Negative_Wave(int currentStep);

/************* Device Definitions ***************/
#if FOSC_Hz > 65536000000  //65.536 GHz
    #error "FOSC is too fast for this code to remain unmodified"
#endif
	
/************* Module Definitions ***************/
#define CbTRIS	OC7CON2bits.OCTRIS
#define DbTRIS	OC8CON2bits.OCTRIS

void Initialize_Inverter(void)
{

//	//OC5 - Ct

//  //OC5 - Output_Inverter_Pos-Fire

	OC5RS = PERIOD;
	OC5R = 800;
	OC5CON1				= 0;
	OC5CON2				= 0;
	OC5CON1bits.OCTSEL	= 0b111;	//111 = Peripheral Clock (FCY)
	OC5CON1bits.OCM		= 0b110;	//110 = Edge-Aligned PWM mode on OCx
	OC5CON2bits.SYNCSEL	= 0b11111;	//11111 = This OC module
	OC5CON2bits.OCINV	= 0;		//0 = OCx output is not inverted
	OC5CON2bits.OCTRIG	= 0;		//0 = Synchronize OCx with source designated by SYNCSELx bits
	OC5CON2bits.OCTRIS	= 0;		//0 = Output Compare Peripheral x connected to the OCx pin


//	//OC6 - Dt

//	//OC6 - Output_Inverter_Neg-Fire

	OC6RS = PERIOD;
	OC6R = 0;
	OC6CON1				= 0;
	OC6CON2				= 0;
	OC6CON1bits.OCTSEL	= 0b111;	//111 = Peripheral Clock (FCY)
	OC6CON1bits.OCM		= 0b110;	//110 = Edge-Aligned PWM mode on OCx
	OC6CON2bits.SYNCSEL	= 0b00101;	//00101 = Output Compare 5
	OC6CON2bits.OCINV	= 0;		//0 = OCx output is not inverted
	OC6CON2bits.OCTRIG	= 0;		//1 = Trigger OCx from source designated by SYNCSELx bits
	OC6CON2bits.OCTRIS	= 0;		//0 = Output Compare Peripheral x connected to the OCx pin

	//OC7 - Output_Inverter_Pos-Bottom
	OC7RS = PERIOD;
	OC7R = 0;
	OC7CON1				= 0;
	OC7CON2				= 0;
	OC7CON1bits.OCTSEL	= 0b111;	//111 = Peripheral Clock (FCY)
	OC7CON1bits.OCM		= 0b110;	//101= Double Compare Continuous Pulse mode: initialize OCx pin low, toggle OCx state continuously on alternate matches of OCxR and OCxRS
	OC7CON2bits.SYNCSEL	= 0b11111;	//00101 = Output Compare 5
	OC7CON2bits.OCINV	= 0;		//0 = OCx output is not inverted
	OC7CON2bits.OCTRIG	= 0;		//0 = Synchronize OCx with source designated by SYNCSELx bits
	OC7CON2bits.OCTRIS	= 0;		//0 = Output Compare Peripheral x connected to the OCx pin

	//OC8 - Output_Inverter_Neg-Bottom
	OC8RS = PERIOD;
	OC8R = 0;
	OC8CON1				= 0;
	OC8CON2				= 0;
	OC8CON1bits.OCTSEL	= 0b111;	//111 = Peripheral Clock (FCY)
	OC8CON1bits.OCM		= 0b110;	//101= Double Compare Continuous Pulse mode: initialize OCx pin low, toggle OCx state continuously on alternate matches of OCxR and OCxRS
	OC8CON2bits.SYNCSEL	= 7;		//00101 = Output Compare 5
	OC8CON2bits.OCINV	= 0;		//0 = OCx output is not inverted
	OC8CON2bits.OCTRIG	= 0;		//0 = Synchronize OCx with source designated by SYNCSELx bits
	OC8CON2bits.OCTRIS	= 0;		//0 = Output Compare Peripheral x connected to the OCx pin

	return;
}

void Inverter_Routine(unsigned long time_mS)
{
	static int VoutTartget = 0;
	static int VoutScaling = 0;
	static int maxVoutScalingStep = 0;
	static int currentStep = 0;

	if(currentStep < 180)
		Positive_Wave(currentStep);
	else if(currentStep == 181)
	{
		OC7R = 0;
		OC8R = 0;
	}
	else if(currentStep < 361)
		Negative_Wave(currentStep-361);
	else if(currentStep >= 362)
	{
		OC7R = 0;
		OC8R = 0;
	}
		
	if(currentStep >= 362)
		currentStep = 0;
	else
		++currentStep;

    return;
}
void Positive_Wave(int currentStep)
{
	//Generate Positive Sine Wave
	OC7R = (inverterLevel[currentStep]*MULTIPLIER)/DIVIDER;	//OC7 - Ab & Cb
//	OC7R = 500;	//OC7 - Ab & Cb
//	OC8R = 0;	//OC8 - Bb & Db

	return;
}

void Negative_Wave(int currentStep)
{
	//Generate Negative Sine Wave
	OC8R = (inverterLevel[currentStep]*MULTIPLIER)/DIVIDER;	//OC8 - Db
//	OC7R = 0;	//OC7 - Ab & Cb
//	OC8R = 500;	//OC8 - Bb & Db

	return;
}
